import bpy
from bpy.app.handlers import load_post, persistent
from bl_ui.space_toolsystem_toolbar import VIEW3D_PT_tools_active, _defs_transform, _defs_annotate, _defs_sculpt
from bl_ui.space_toolsystem_common import ToolDef, ToolSelectPanelHelper
from bl_ui.properties_paint_common import UnifiedPaintPanel, brush_settings, brush_settings_advanced, brush_texture_settings, StrokePanel, FalloffPanel

from typing import List

from sculpt_plus.props import Props

unregistered_tools: List[ToolDef] = []

builtin_draw_toolbar = VIEW3D_PT_tools_active.draw


def draw_settings__sculpt_brush_tool(self, context, tool):
    props = tool.operator_properties("SCULPT_OT_brush_stroke")

def _layout_generator_single_row(layout, scale_y):
    col = layout.row(align=True)
    #col.scale_y = scale_y
    is_sep = False
    while True:
        if is_sep is True:
            col = layout.row(align=True)
            col.scale_y = scale_y
        elif is_sep is None:
            yield None
            return
        is_sep = yield col

def draw_cls(cls, layout, context, detect_layout=True, default_layout='COL', scale_y=1.75, spacing=0.25):
    # Use a classmethod so it can be called outside of a panel context.

    # XXX, this UI isn't very nice.
    # We might need to create new button types for this.
    # Since we probably want:
    # - tool-tips that include multiple key shortcuts.
    # - ability to click and hold to expose sub-tools.

    space_type = context.space_data.type
    tool_active_id = getattr(
        ToolSelectPanelHelper._tool_active_from_context(context, space_type),
        "idname", None,
    )

    if detect_layout:
        ui_gen, show_text = cls._layout_generator_detect_from_region(layout, context.region, scale_y)
    else:
        if default_layout == 'COL':
            ui_gen = ToolSelectPanelHelper._layout_generator_single_column(layout, scale_y)
        else:
            ui_gen = _layout_generator_single_row(layout, scale_y)
        show_text = True

    # Start iteration
    ui_gen.send(None)

    skip_draw_mask = True
    skip_draw_face_sets = True

    for item in cls.tools_from_context(context):
        if item is None:
            ui_gen.send(True)
            layout.separator(factor=spacing)
            continue

        if type(item) is tuple:
            is_active = False
            i = 0
            for i, sub_item in enumerate(item):
                if sub_item is None:
                    continue
                is_active = (sub_item.idname == tool_active_id)
                if is_active:
                    index = i
                    break
            del i, sub_item

            if is_active:
                # not ideal, write this every time :S
                cls._tool_group_active[item[0].idname] = index
            else:
                index = cls._tool_group_active_get_from_item(item)

            item = item[index]
            use_menu = True
        else:
            index = -1
            use_menu = False

        # SKIP first mask and face sets draw brushes.
        if 'builtin_brush' in item.idname:
            
            brush_name: str = item.idname.split('.')[1].replace(' ', '_').upper()
            if brush_name == 'MASK':
                if skip_draw_mask:
                    skip_draw_mask = False
                    continue
            elif brush_name == 'DRAW_FACE_SETS':
                if skip_draw_face_sets:
                    skip_draw_face_sets = False
                    continue
            else:
                continue

        is_active = (item.idname == tool_active_id)
        icon_value = ToolSelectPanelHelper._icon_value_from_icon_handle(item.icon)

        sub = ui_gen.send(False)

        if use_menu:
            sub.operator_menu_hold(
                "wm.tool_set_by_id",
                text=item.label if show_text else "",
                depress=is_active,
                menu="WM_MT_toolsystem_submenu",
                icon_value=icon_value,
            ).name = item.idname
        else:
            sub.operator(
                "wm.tool_set_by_id",
                text=item.label if show_text else "",
                depress=is_active,
                icon_value=icon_value,
            ).name = item.idname
    # Signal to finish any remaining layout edits.
    ui_gen.send(None)

def draw_toolbar(self, context):
    if context.mode != 'SCULPT':
        self.draw_cls(self.layout, context)
        return

    # toolbar_is_wide_open
    if context.region.width <= 96:
        draw_cls(VIEW3D_PT_tools_active, self.layout, context, spacing=0.1)
        return

    from sculpt_plus.core.data.wm import SCULPTPLUS_PG_ui_toggles
    ui_props: SCULPTPLUS_PG_ui_toggles = Props.UI(context)

    sculpt = context.tool_settings.sculpt
    act_brush = sculpt.brush

    layout = self.layout
    factor = 1.0 - (context.region.width - 96/2) / context.region.width
    row = layout.split(align=False, factor=factor)

    col_1 = row.column(align=False)

    # DYN-SEP.
    prefs = context.preferences
    reg = context.region
    view_scroll_y = -reg.view2d.region_to_view(0, reg.height-1)[1]
    ui_scale = prefs.view.ui_scale
    line_height_px = 40 * ui_scale
    offset_factor_y = view_scroll_y / line_height_px
    sep = col_1.column(align=True)
    sep.label(text='', icon='BLANK1')
    sep.scale_y = (offset_factor_y-.05) * 2.0

    # TOOLBAR.
    toolbar = col_1.column(align=True)
    draw_cls(VIEW3D_PT_tools_active, toolbar, context, spacing=1.0) # row, context, detect_layout=False, default_layout='ROW', scale_y=1.35

    # BRUSH SETTINGS.
    col_2 = row.column()
    col_2.use_property_split = True

    section = col_2.column(align=True)
    header = section.row(align=True)
    header.use_property_split = False
    header.box().label(text='', icon='BRUSH_DATA')
    icon = 'TRIA_DOWN' if ui_props.show_brush_settings else 'TRIA_RIGHT'
    header_toggle = header.box().row(align=True)
    header_toggle.emboss = 'NONE'
    header_toggle.prop(ui_props, 'show_brush_settings', text="Brush Settings", toggle=False)
    header_toggle.prop(ui_props, 'show_brush_settings', text="", icon=icon, toggle=False)
    if ui_props.show_brush_settings:
        brush_settings(section.box(), context, act_brush)
        icon = 'TRIA_DOWN' if ui_props.show_brush_settings_advanced else 'TRIA_RIGHT'
        header = section.row(align=True)
        header.use_property_split = False
        header.box().label(text='', icon='PROP_CON')
        header_toggle = header.box().row(align=True)
        header_toggle.emboss = 'NONE'
        header_toggle.prop(ui_props, 'show_brush_settings_advanced', text="Advanced", toggle=False)
        header_toggle.prop(ui_props, 'show_brush_settings_advanced', text="", icon=icon, toggle=False)
        if ui_props.show_brush_settings_advanced:
            brush_settings_advanced(section.box(), context, act_brush)

    class DummyPanel(StrokePanel):
        def __init__(self, layout):
            self.layout = layout

    col_2.separator()

    section = col_2.column(align=True)
    header = section.row(align=True)
    header.use_property_split = False
    header.box().label(text='', icon='GP_SELECT_STROKES')
    icon = 'TRIA_DOWN' if ui_props.show_brush_settings_stroke else 'TRIA_RIGHT'
    header_toggle = header.box().row(align=True)
    header_toggle.emboss = 'NONE'
    header_toggle.prop(ui_props, 'show_brush_settings_stroke', text="Stroke Settings", toggle=False)
    header_toggle.prop(ui_props, 'show_brush_settings_stroke', text="", icon=icon, toggle=False)
    if ui_props.show_brush_settings_stroke:
        StrokePanel.draw(DummyPanel(section.box()), context)

    col_2.separator()

    section = col_2.column(align=True)
    header = section.row(align=True)
    header.use_property_split = False
    header.box().label(text='', icon='SMOOTHCURVE')
    icon = 'TRIA_DOWN' if ui_props.show_brush_settings_falloff else 'TRIA_RIGHT'
    header_toggle = header.box().row(align=True)
    header_toggle.emboss = 'NONE'
    header_toggle.prop(ui_props, 'show_brush_settings_falloff', text="Falloff Settings", toggle=False)
    header_toggle.prop(ui_props, 'show_brush_settings_falloff', text="", icon=icon, toggle=False)
    if ui_props.show_brush_settings_falloff:
        StrokePanel.draw(DummyPanel(section.box()), context)

    col_2.separator()

    section = col_2.column(align=True)
    header = section.row(align=True)
    header.use_property_split = False
    header.box().label(text='', icon='TEXTURE_DATA')
    icon = 'TRIA_DOWN' if ui_props.show_brush_settings_texture else 'TRIA_RIGHT'
    header_toggle = header.box().row(align=True)
    header_toggle.emboss = 'NONE'
    header_toggle.prop(ui_props, 'show_brush_settings_texture', text="Texture Settings", toggle=False)
    header_toggle.prop(ui_props, 'show_brush_settings_texture', text="", icon=icon, toggle=False)
    if ui_props.show_brush_settings_texture:
        brush_texture_settings(section.box(), act_brush, sculpt=True)


def draw_toolbar_pre(self, context):
    return
    act_brush = context.tool_settings.sculpt.brush
    self.layout.label(text=act_brush.name)

    self.layout.separator()

def draw_toolbar_post(self, context):
    return
    act_brush = context.tool_settings.sculpt.brush

    self.layout.separator()

    self.layout.prop(act_brush, 'size', slider=True)


def generate_from_brushes(dummy=None):
    tool_defs = {}
    idname_prefix="builtin_brush."
    icon_prefix="brush.sculpt."
    type=bpy.types.Brush
    attr="sculpt_tool"
    for enum in type.bl_rna.properties[attr].enum_items_static:
        name = enum.name
        idname = enum.identifier
        if idname not in {'MASK', 'DRAW_FACE_SETS'}:
            continue
        tool_defs[idname] = ToolDef.from_dict(
            dict(
                idname=idname_prefix + name,
                label=name,
                icon=icon_prefix + idname.lower(),
                cursor='DEFAULT',
                data_block=idname,
            )
        )
    '''
    name = "Sculpt Brush"
    idname = "SCULPT_BRUSH"
    tool_defs[idname] = ToolDef.from_dict(
        dict(
            idname='sculpt_plus.' + name,
            label=name,
            icon=icon_prefix + 'draw',
            cursor='DEFAULT',
            keymap="3D View Tool: Sculpt",
            #data_block='SCULPT DRAW',
            draw_settings=draw_settings__sculpt_brush_tool,
            operator='sculpt.brush_stroke',
            #options={'KEYMAP_FALLBACK'},
        )
    )
    '''
    return tool_defs


@persistent
def on_post_load(dummy):
    from sculpt_plus.prefs import get_prefs
    if not get_prefs(bpy.context).first_time:
        return
    print("[Sculpt+] Installation complete!")
    get_prefs(bpy.context).first_time = False
    return
    print("[Sculpt+] Unregistering Sculpt brush tools...")
    from bpy.utils import unregister_tool
    tools: List[ToolDef] = list(VIEW3D_PT_tools_active.tools_from_context(bpy.context, mode='SCULPT'))
    for tool in tools:
        if 'builtin_brush' in tool.idname:
            # Unregister brush tools.
            unregister_tool(tool)
            unregistered_tools.append(tool)


def set_sculpt_tools():
    tools = generate_from_brushes()
    VIEW3D_PT_tools_active._tools['SCULPT'] = [
        #tools['SCULPT_BRUSH'],
        _defs_sculpt.generate_from_brushes, # NOW These brush tools are skiped in the UI, hidden.
        None,
        tools['MASK'],
        (
            _defs_sculpt.mask_border,
            _defs_sculpt.mask_lasso,
            _defs_sculpt.mask_line,
        ),
        _defs_sculpt.mask_by_color,
        None,
        tools['DRAW_FACE_SETS'],
        (
            _defs_sculpt.face_set_box,
            _defs_sculpt.face_set_lasso,
        ),
        _defs_sculpt.face_set_edit,
        None,
        _defs_sculpt.hide_border,
        (
            _defs_sculpt.trim_box,
            _defs_sculpt.trim_lasso,
        ),
        _defs_sculpt.project_line,
        None,
        _defs_sculpt.mesh_filter,
        _defs_sculpt.cloth_filter,
        _defs_sculpt.color_filter,
        None,
        _defs_transform.translate,
        _defs_transform.rotate,
        _defs_transform.scale,
        _defs_transform.transform,
        None,
        *VIEW3D_PT_tools_active._tools_annotate,
    ]

def register():
    load_post.append(on_post_load)

    VIEW3D_PT_tools_active.draw = draw_toolbar
    VIEW3D_PT_tools_active.prepend(draw_func=draw_toolbar_pre)
    VIEW3D_PT_tools_active.append(draw_func=draw_toolbar_post)

    #bpy.types.Brush.bl_rna
    #.use_custom_icon.update = lambda self, ctx: print("Brush Update: use_custom_icon -> ", self.use_custom_icon)

    if 'SCULPT' in VIEW3D_PT_tools_active._tools:
        # tool_items = VIEW3D_PT_tools_active._tools['SCULPT']
        # remove '_defs_sculpt.generate_from_brushes'
        #if unregistered_tools == []:
            # del VIEW3D_PT_tools_active._tools['SCULPT']
            # VIEW3D_PT_tools_active._tools['SCULPT'].pop(0)
            # VIEW3D_PT_tools_active._tools['SCULPT'][0] = _defs_sculpt.generate_from_brushes
        set_sculpt_tools()

def unregister():
    if on_post_load in load_post:
        load_post.remove(on_post_load)
    
    VIEW3D_PT_tools_active.remove(draw_func=draw_toolbar_pre)
    VIEW3D_PT_tools_active.remove(draw_func=draw_toolbar_post)
